services:
  mysql:
    image: mysql:8.0
    container_name: pipeline-mysql
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: pipeline_cloud
    volumes:
      - ./data/mysql:/var/lib/mysql
      - ./sql/schema.sql:/docker-entrypoint-initdb.d/schema.sql:ro
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 20

  redis:
    image: redis:7.0
    container_name: pipeline-redis
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 20

  nacos:
    image: nacos/nacos-server:v2.2.3
    container_name: pipeline-nacos
    ports:
      - "8848:8848"
      - "9848:9848"
    environment:
      MODE: standalone
      JVM_XMS: 256m
      JVM_XMX: 256m
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8848/nacos/"]
      interval: 15s
      timeout: 5s
      retries: 30

  pipeline-auth:
    build:
      context: .
      dockerfile: Dockerfile.service
      args:
        SERVICE_MODULE: pipeline-auth
        HTTP_PROXY: ${HTTP_PROXY}
        HTTPS_PROXY: ${HTTPS_PROXY}
        NO_PROXY: ${NO_PROXY}
    container_name: pipeline-auth
    environment:
      SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR: pipeline-nacos:8848
      SPRING_DATASOURCE_URL: jdbc:mysql://pipeline-mysql:3306/pipeline_cloud?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=false&serverTimezone=GMT%2B8
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      SPRING_REDIS_HOST: pipeline-redis
      SPRING_REDIS_PORT: 6379
      JAVA_OPTS: -Xms256m -Xmx512m -Dfile.encoding=UTF-8
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      nacos:
        condition: service_healthy

  pipeline-system:
    build:
      context: .
      dockerfile: Dockerfile.service
      args:
        SERVICE_MODULE: pipeline-system
        HTTP_PROXY: ${HTTP_PROXY}
        HTTPS_PROXY: ${HTTPS_PROXY}
        NO_PROXY: ${NO_PROXY}
    container_name: pipeline-system
    environment:
      SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR: pipeline-nacos:8848
      SPRING_DATASOURCE_URL: jdbc:mysql://pipeline-mysql:3306/pipeline_cloud?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=false&serverTimezone=GMT%2B8
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      SPRING_REDIS_HOST: pipeline-redis
      SPRING_REDIS_PORT: 6379
      JAVA_OPTS: -Xms256m -Xmx512m -Dfile.encoding=UTF-8
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      nacos:
        condition: service_healthy

  pipeline-data:
    build:
      context: .
      dockerfile: Dockerfile.service
      args:
        SERVICE_MODULE: pipeline-data
        HTTP_PROXY: ${HTTP_PROXY}
        HTTPS_PROXY: ${HTTPS_PROXY}
        NO_PROXY: ${NO_PROXY}
    container_name: pipeline-data
    environment:
      SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR: pipeline-nacos:8848
      SPRING_DATASOURCE_URL: jdbc:mysql://pipeline-mysql:3306/pipeline_cloud?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=false&serverTimezone=GMT%2B8
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      JAVA_OPTS: -Xms256m -Xmx512m -Dfile.encoding=UTF-8
    depends_on:
      mysql:
        condition: service_healthy
      nacos:
        condition: service_healthy

  pipeline-calculation:
    build:
      context: .
      dockerfile: Dockerfile.service
      args:
        SERVICE_MODULE: pipeline-calculation
        HTTP_PROXY: ${HTTP_PROXY}
        HTTPS_PROXY: ${HTTPS_PROXY}
        NO_PROXY: ${NO_PROXY}
    container_name: pipeline-calculation
    environment:
      SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR: pipeline-nacos:8848
      JAVA_OPTS: -Xms256m -Xmx512m -Dfile.encoding=UTF-8
    depends_on:
      nacos:
        condition: service_healthy

  pipeline-gateway:
    build:
      context: .
      dockerfile: Dockerfile.service
      args:
        SERVICE_MODULE: pipeline-gateway
        HTTP_PROXY: ${HTTP_PROXY}
        HTTPS_PROXY: ${HTTPS_PROXY}
        NO_PROXY: ${NO_PROXY}
    container_name: pipeline-gateway
    ports:
      - "8080:8080"
    environment:
      SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR: pipeline-nacos:8848
      SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR: pipeline-nacos:8848
      SPRING_REDIS_HOST: pipeline-redis
      SPRING_REDIS_PORT: 6379
      JAVA_OPTS: -Xms256m -Xmx512m -Dfile.encoding=UTF-8
    depends_on:
      redis:
        condition: service_healthy
      nacos:
        condition: service_healthy
      pipeline-auth:
        condition: service_started
      pipeline-system:
        condition: service_started
      pipeline-data:
        condition: service_started
      pipeline-calculation:
        condition: service_started

  pipeline-react:
    build:
      context: ../pipeline-react
      dockerfile: Dockerfile
      args:
        HTTP_PROXY: ${HTTP_PROXY}
        HTTPS_PROXY: ${HTTPS_PROXY}
        NO_PROXY: ${NO_PROXY}
    container_name: pipeline-react
    ports:
      - "3000:80"
    depends_on:
      - pipeline-gateway
