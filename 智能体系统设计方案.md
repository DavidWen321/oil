# 管道能耗智能体系统 - 综合设计方案

> **版本**: 3.0 (2025年11月最新)
> **日期**: 2025-11
> **定位**: 融合2025年最先进RAG技术与多Agent协作的生产级智能体系统
> **核心技术**: LangGraph 1.0 + HyPE + Agentic RAG + CRAG + Contextual Retrieval

---

## 技术更新日志 (2025年11月)

| 技术 | 更新说明 | 效果提升 |
|------|----------|----------|
| **LangGraph 1.0** | 2025年10月发布的首个稳定版，支持checkpointing、streaming | 生产级稳定性 |
| **HyPE** | 替代HyDE，预计算假设问题而非假设答案，检索时无需LLM调用 | 精度+42%，速度更快 |
| **Agentic RAG** | RAG与Agent深度融合，智能判断检索策略 | 复杂问答能力大幅提升 |
| **CRAG** | Corrective RAG，检索质量评估+Web搜索降级 | 减少幻觉 |
| **Contextual Retrieval** | Anthropic方案，为chunk添加上下文 | 检索准确率+49% |

---

## 一、设计目标

### 1.1 核心能力

```
用户自然语言输入
        ↓
┌─────────────────────────────────────────────────────────────┐
│                    智能体系统核心能力                         │
├─────────────────────────────────────────────────────────────┤
│  ✓ 意图理解 - 准确识别用户需求类型                           │
│  ✓ 自适应检索 - 智能判断是否需要检索知识库                    │
│  ✓ 多Agent协作 - Supervisor调度专业Agent                    │
│  ✓ 上下文增强 - Contextual Retrieval提升检索49%             │
│  ✓ 多轮对话 - Memory机制支持连续交互                         │
│  ✓ 精准计算 - 调用Java服务执行专业水力学计算                  │
└─────────────────────────────────────────────────────────────┘
        ↓
专业、准确、可追溯的回答
```

### 1.2 典型场景

| 场景 | 示例输入 | 系统行为 |
|------|----------|----------|
| 知识问答 | "什么是雷诺数？" | Knowledge Agent + Contextual RAG |
| 数据查询 | "查询项目P001的管道参数" | Data Agent + SQL生成 |
| 专业计算 | "计算流量100时的水力特性" | Calc Agent + Java服务 |
| 复合分析 | "分析P001管道并给出优化建议" | 多Agent协作 + 结果聚合 |

---

## 二、系统架构

### 2.1 整体架构

```
                                用户/前端
                                    │
                                    ▼
┌───────────────────────────────────────────────────────────────────┐
│                      Java Gateway (8080)                           │
│                      /agent/** → Agent Gateway                     │
└─────────────────────────────────┬─────────────────────────────────┘
                                  │
                                  ▼
┌───────────────────────────────────────────────────────────────────┐
│                   Agent Gateway (FastAPI 8100)                     │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                    LangGraph Workflow                        │  │
│  │                                                              │  │
│  │   ┌──────────────┐      ┌─────────────────────────────┐     │  │
│  │   │Intent Router │ ──→  │      Supervisor Agent       │     │  │
│  │   │  意图路由     │      │  任务分解 + Agent调度 + 汇总 │     │  │
│  │   └──────────────┘      └──────────────┬──────────────┘     │  │
│  │                                        │                     │  │
│  │                    ┌───────────────────┼───────────────────┐ │  │
│  │                    │                   │                   │ │  │
│  │                    ▼                   ▼                   ▼ │  │
│  │            ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  │            │ Data Agent  │     │ Calc Agent  │     │Knowledge    │
│  │            │ 数据查询     │     │ 水力计算     │     │Agent        │
│  │            └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
│  │                   │                   │                   │ │  │
│  └───────────────────┼───────────────────┼───────────────────┼─┘  │
└──────────────────────┼───────────────────┼───────────────────┼────┘
                       │                   │                   │
                       ▼                   ▼                   ▼
                ┌──────────┐        ┌──────────┐        ┌──────────────┐
                │  MySQL   │        │Java Calc │        │   Milvus     │
                │  数据库   │        │  Service │        │ Contextual   │
                │          │        │  (9500)  │        │    RAG       │
                └──────────┘        └──────────┘        └──────────────┘
```

### 2.2 Agentic RAG 架构（2025年最新）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Agentic RAG Pipeline (2025)                               │
│            Contextual Retrieval + HyPE + CRAG + Self-RAG                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │              1. 文档预处理层 (索引时执行，一次性)                        │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐  ┌────────────┐  │  │
│  │  │ Semantic     │→ │ Contextual   │→ │ HyPE预生成  │→ │ Hybrid     │  │  │
│  │  │ Chunking     │  │ Headers      │  │ 假设问题    │  │ Embedding  │  │  │
│  │  │ 语义分块     │  │ 上下文说明    │  │ (替代HyDE)  │  │ Dense+Sparse│  │  │
│  │  └──────────────┘  └──────────────┘  └─────────────┘  └────────────┘  │  │
│  │                                                                        │  │
│  │  HyPE优势: 索引时预计算假设问题，检索时无需LLM调用，精度+42%，速度更快    │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                      ↓                                       │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │              2. Agentic 检索决策层 (Self-RAG)                          │  │
│  │  ┌────────────────────────────────────────────────────────────────┐   │  │
│  │  │  LLM判断: 这个问题需要检索吗?                                    │   │  │
│  │  │  ├─ 简单计算/闲聊 → 直接回答，跳过检索                           │   │  │
│  │  │  ├─ 专业概念/规范 → 触发RAG检索                                  │   │  │
│  │  │  └─ 数据查询 → 转SQL Agent                                       │   │  │
│  │  └────────────────────────────────────────────────────────────────┘   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                      ↓                                       │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │              3. 混合检索层 (Hybrid Search)                             │  │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐    │  │
│  │  │  Dense Retrieval │  │ Sparse Retrieval │  │ Metadata Filter  │    │  │
│  │  │  BGE-M3向量检索   │  │  BM25关键词检索   │  │  分类/标签过滤   │    │  │
│  │  └────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘    │  │
│  │           └──────────────────────┼───────────────────┘               │  │
│  │                                  ▼                                    │  │
│  │                      ┌──────────────────┐                            │  │
│  │                      │  RRF Fusion      │                            │  │
│  │                      │  倒数排名融合     │                            │  │
│  │                      └──────────────────┘                            │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                      ↓                                       │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │              4. CRAG 纠正检索层 (Corrective RAG)                       │  │
│  │  ┌────────────────────────────────────────────────────────────────┐   │  │
│  │  │  LLM评估检索质量:                                               │   │  │
│  │  │  ├─ 相关性高 → 使用检索结果生成回答                              │   │  │
│  │  │  ├─ 相关性中 → 知识精炼(提取关键信息) + 补充检索                  │   │  │
│  │  │  └─ 相关性低 → 触发Web搜索降级 或 提示"知识库无相关内容"          │   │  │
│  │  └────────────────────────────────────────────────────────────────┘   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                      ↓                                       │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │              5. 结果优化层                                             │  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌───────────┐ │  │
│  │  │ Re-ranking   │→ │ Deduplication│→ │ Compression  │→ │ Citation  │ │  │
│  │  │ BGE-Reranker │  │ 去重过滤      │  │ 上下文压缩   │  │ 引用标注  │ │  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └───────────┘ │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 HyPE vs HyDE 对比 (2025年新技术)

| 维度 | HyDE (2022) | HyPE (2025) |
|------|-------------|-------------|
| **原理** | 查询时生成假设**答案**再检索 | 索引时预生成假设**问题** |
| **检索时LLM调用** | 需要 (增加延迟) | **不需要** (更快) |
| **精度提升** | ~30% | **~42%** |
| **召回提升** | ~25% | **~45%** |
| **适用场景** | 开放域问答 | **专业知识库** (更适合本项目) |

```
HyPE工作原理:

索引阶段 (一次性):
┌─────────────────────────────────────────────────────────────┐
│ 原始Chunk: "雷诺数Re=vd/ν，是判断流态的无量纲数..."           │
│                          ↓                                  │
│ LLM生成多个假设问题:                                         │
│   Q1: "什么是雷诺数？"                                       │
│   Q2: "雷诺数的计算公式是什么？"                             │
│   Q3: "如何用雷诺数判断流态？"                               │
│                          ↓                                  │
│ 存储: [Q1_embedding, Q2_embedding, Q3_embedding] → Chunk    │
└─────────────────────────────────────────────────────────────┘

检索阶段 (每次查询):
┌─────────────────────────────────────────────────────────────┐
│ 用户查询: "雷诺数怎么算？"                                    │
│                          ↓                                  │
│ 直接与预存储的假设问题向量匹配 (问题-问题匹配)                  │
│                          ↓                                  │
│ 匹配到Q2: "雷诺数的计算公式是什么？" → 返回对应Chunk           │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 Contextual Retrieval 核心原理

**传统RAG的问题：**
```
原始文档: "管道水力学设计规范 GB50251-2015
         第3章 水力计算
         3.2 雷诺数计算
         Re = vd/ν，其中v为流速..."

传统分块后:
  Chunk: "Re = vd/ν，其中v为流速..."
  问题: 丢失了"这是GB50251规范第3章"的上下文！
```

**Contextual Retrieval方案：**
```
处理流程:
1. 分块: "Re = vd/ν，其中v为流速..."

2. LLM生成上下文说明:
   Prompt: "请为以下chunk生成简短的上下文说明，说明它在整个文档中的位置和作用"

   生成: "本段落来自《管道水力学设计规范GB50251》第3章水力计算部分，
         描述了雷诺数的基本计算公式。"

3. 拼接后存储:
   "[上下文] 本段落来自《管道水力学设计规范GB50251》第3章...
    [原文] Re = vd/ν，其中v为流速..."

效果: 检索准确率提升49%，特别是专业术语和标准引用场景
```

---

## 三、Agent 详细设计

### 3.1 Agent State 定义

```python
from typing import TypedDict, Annotated, List, Optional, Literal
from langgraph.graph.message import add_messages
from langchain_core.messages import BaseMessage

class AgentState(TypedDict):
    """统一的Agent状态定义"""

    # ===== 消息管理 =====
    messages: Annotated[List[BaseMessage], add_messages]  # 对话历史
    user_input: str                                        # 当前用户输入

    # ===== 意图与任务 =====
    intent: Literal["query", "calculate", "knowledge", "complex", "chat"]
    sub_tasks: List[dict]           # 分解的子任务列表
    current_task_index: int         # 当前执行的任务索引
    completed_tasks: List[dict]     # 已完成的任务及结果

    # ===== 数据存储 =====
    pipeline_data: Optional[dict]         # 管道数据
    calculation_result: Optional[dict]    # 计算结果
    knowledge_context: Optional[str]      # 知识检索结果
    knowledge_sources: List[dict]         # 引用来源

    # ===== 流程控制 =====
    next_agent: str                       # 下一个执行的Agent
    should_retrieve: bool                 # Self-RAG: 是否需要检索
    iteration: int                        # 当前迭代次数
    max_iterations: int                   # 最大迭代次数(防止死循环)

    # ===== 错误处理 =====
    error_message: Optional[str]          # 错误信息
    error_count: int                      # 错误计数

    # ===== Memory =====
    session_id: str                       # 会话ID
    chat_history_summary: Optional[str]   # 历史对话摘要(长对话压缩)

    # ===== 输出 =====
    final_response: Optional[str]         # 最终响应
    confidence_score: float               # 回答置信度
    execution_trace: List[dict]           # 执行轨迹(用于调试)
```

### 3.2 Agent 角色定义

#### A. Supervisor Agent（核心调度器）

```python
SUPERVISOR_PROMPT = """你是管道能耗分析系统的AI调度器。

## 你的职责
1. 分析用户意图，判断任务类型
2. 将复杂任务分解为子任务
3. 决定调用哪个Agent执行
4. 汇总各Agent结果，生成最终回答

## 可用的Agent
- data_agent: 查询数据库中的项目、管道、泵站、油品数据
- calc_agent: 执行水力计算、泵优化、能耗分析
- knowledge_agent: 检索知识库回答专业问题

## 任务类型判断
- query: 查询数据库 → data_agent
- calculate: 数值计算 → calc_agent (可能需要先调data_agent获取参数)
- knowledge: 概念解释、规范查询 → knowledge_agent
- complex: 复合任务 → 按顺序调度多个Agent
- chat: 简单闲聊 → 直接回复

## 输出格式
{
    "intent": "任务类型",
    "sub_tasks": [
        {"agent": "agent名称", "task": "具体任务描述", "depends_on": []},
        ...
    ],
    "reasoning": "你的分析过程"
}
"""
```

#### B. Data Agent（数据查询）

```python
DATA_AGENT_TOOLS = [
    # 项目查询
    "query_projects",        # 查询所有项目
    "query_project_by_id",   # 按ID查询项目
    "query_project_by_name", # 按名称查询项目

    # 管道查询
    "query_pipelines",       # 查询项目下的管道
    "query_pipeline_detail", # 查询管道详情

    # 泵站查询
    "query_pump_stations",   # 查询泵站列表

    # 油品查询
    "query_oil_properties",  # 查询油品参数

    # 通用SQL(受限)
    "execute_safe_sql",      # 执行安全的SELECT查询
]

DATA_AGENT_PROMPT = """你是数据查询专家，负责从数据库获取管道能耗系统的业务数据。

## 数据库表结构
- t_project: 项目表 (pro_id, number, name, responsible, build_date)
- t_pipeline: 管道表 (id, pro_id, name, length, diameter, thickness, throughput, ...)
- t_pump_station: 泵站表 (id, name, pump_efficiency, displacement, ...)
- t_oil_property: 油品表 (id, name, density, viscosity)

## 安全规则
- 只能执行SELECT查询
- 禁止访问sys_user表的password字段
- 查询结果超过100条时自动分页

## 输出要求
- 返回结构化数据
- 数值带单位说明
- 没查到数据时明确告知
"""
```

#### C. Calc Agent（水力计算）

```python
CALC_AGENT_TOOLS = [
    # 基础计算
    "calculate_reynolds",        # 计算雷诺数
    "calculate_flow_regime",     # 判断流态
    "calculate_friction_loss",   # 计算摩阻损失

    # 综合分析(调用Java服务)
    "call_hydraulic_analysis",   # 水力特性分析
    "call_optimization",         # 泵组合优化

    # 辅助计算
    "calculate_energy_cost",     # 能耗费用计算
    "compare_schemes",           # 方案对比
]

CALC_AGENT_PROMPT = """你是水力计算专家，负责执行管道水力学计算和泵站优化分析。

## 核心计算能力
1. 雷诺数计算: Re = vd/ν
2. 流态判断: 层流(<2000)、过渡区、湍流(>3000)
3. 沿程摩阻: h = β·Q^(2-m)·ν^m/d^(5-m)·L
4. 泵扬程与能耗

## 参数要求
- 流量: m³/h
- 管径: mm
- 粘度: m²/s
- 长度: km
- 密度: kg/m³

## 计算流程
1. 检查参数是否完整
2. 参数不完整时，请求调用data_agent获取
3. 执行计算并解释结果
4. 对异常值给出警告
"""
```

#### D. Knowledge Agent（知识检索）

```python
KNOWLEDGE_AGENT_PROMPT = """你是管道工程知识专家，负责检索知识库回答专业问题。

## 知识库内容
- 国标/行标: GB50251管道设计规范、SY/T石油行业标准
- 计算原理: 水力学公式推导、流体力学原理
- 操作指南: 泵站操作规程、故障诊断手册
- 案例分析: 优化案例、事故分析

## Self-RAG判断
先判断是否需要检索知识库:
- 需要检索: 专业术语、规范条文、原理解释
- 不需要检索: 简单计算、数据查询、闲聊

## 回答要求
- 引用知识库来源: [来源: 文档名称]
- 专业术语给出解释
- 不确定时说明局限性
"""
```

---

## 四、Contextual RAG 实现

### 4.1 上下文生成Prompt

```python
CONTEXT_GENERATION_PROMPT = """请为以下文档片段生成简短的上下文说明。

<document>
{whole_document}
</document>

<chunk>
{chunk_content}
</chunk>

请用1-2句话说明这个片段：
1. 来自哪个文档的哪个部分
2. 主要讨论什么内容
3. 与整个文档的关系

上下文说明："""
```

### 4.2 知识库分类

```python
KNOWLEDGE_CATEGORIES = {
    "standards": {
        "name": "技术规范",
        "description": "国标、行标、API标准",
        "confidence": "high",
        "examples": ["GB50251", "SY/T", "API"]
    },
    "formulas": {
        "name": "计算原理",
        "description": "水力学公式、推导过程",
        "confidence": "high",
        "examples": ["雷诺数", "伯努利", "达西公式"]
    },
    "operations": {
        "name": "操作指南",
        "description": "操作规程、维护手册",
        "confidence": "medium",
        "examples": ["启泵流程", "故障排除"]
    },
    "cases": {
        "name": "案例分析",
        "description": "优化案例、事故报告",
        "confidence": "medium",
        "examples": ["XX管道优化", "能耗降低"]
    },
    "faq": {
        "name": "常见问题",
        "description": "FAQ问答对",
        "confidence": "low",
        "examples": ["什么是", "如何", "为什么"]
    }
}
```

### 4.3 检索策略配置

```python
RAG_CONFIG = {
    # 分块配置
    "chunking": {
        "method": "semantic",        # semantic | fixed | sentence
        "chunk_size": 512,
        "chunk_overlap": 50,
        "separators": ["\n\n", "\n", "。", "；"]
    },

    # 上下文增强
    "contextual": {
        "enabled": True,
        "model": "qwen-turbo",       # 用于生成上下文的模型
        "max_context_length": 200    # 上下文最大长度
    },

    # 检索配置
    "retrieval": {
        "dense_weight": 0.7,         # 向量检索权重
        "sparse_weight": 0.3,        # BM25权重
        "top_k": 10,                 # 初始检索数量
        "final_k": 5                 # 重排序后返回数量
    },

    # 查询增强
    "query_enhancement": {
        "hyde_enabled": True,        # HyDE假设文档
        "rewrite_enabled": True,     # 查询改写
        "self_rag_enabled": True     # 自适应检索
    },

    # 重排序
    "reranking": {
        "enabled": True,
        "model": "bge-reranker-base",
        "threshold": 0.5             # 相关性阈值
    }
}
```

---

## 五、技术选型 (2025年11月最新)

| 组件 | 选型 | 版本 | 理由 |
|------|------|------|------|
| **Python** | Python | 3.11+ | 类型提示、异步支持 |
| **Agent框架** | LangChain | 0.3+ | 2025年最新稳定版 |
| **工作流** | **LangGraph** | **1.0+** | **2025年10月首个稳定版，生产级** |
| **向量库** | Milvus | 2.4+ | 开源、Hybrid Search、标量过滤 |
| **Embedding** | BGE-M3 | latest | 多语言、Sparse+Dense+ColBERT |
| **Reranker** | BGE-Reranker-v2 | latest | 2025年最新版，效果更好 |
| **LLM** | Qwen2.5-72B / DeepSeek-V3 | latest | 2025年国产最强，成本低 |
| **Web框架** | FastAPI | 0.115+ | 异步、自动文档 |

### 5.1 LangGraph 1.0 新特性 (2025年10月)

```python
# LangGraph 1.0 关键新特性

# 1. Checkpointing - 断点恢复
from langgraph.checkpoint.memory import MemorySaver
checkpointer = MemorySaver()
graph = workflow.compile(checkpointer=checkpointer)

# 2. Streaming - 流式输出
async for event in graph.astream_events(input, version="v2"):
    print(event)

# 3. Human-in-the-loop - 人工介入
graph = workflow.compile(
    checkpointer=checkpointer,
    interrupt_before=["sensitive_tool"]  # 敏感操作前暂停
)

# 4. State Persistence - 状态持久化
from langgraph.checkpoint.postgres import PostgresSaver
checkpointer = PostgresSaver.from_conn_string(conn_string)

# 5. Subgraphs - 子图嵌套
main_graph.add_node("sub_workflow", sub_graph)
```

### 5.2 2025年RAG技术栈对比

| 技术 | 效果 | 延迟 | 成本 | 推荐场景 |
|------|------|------|------|----------|
| **基础RAG** | ★★☆ | 低 | 低 | 简单FAQ |
| **HyDE** | ★★★ | 高 | 中 | 开放域 |
| **HyPE** | ★★★★ | **低** | 中 | **专业知识库✓** |
| **Contextual** | ★★★★ | 低 | 高 | **文档检索✓** |
| **CRAG** | ★★★★★ | 中 | 中 | **生产系统✓** |
| **Graph RAG** | ★★★★★ | 高 | 高 | 复杂关系推理 |

**本项目选择**: HyPE + Contextual + CRAG 组合，平衡效果与成本

---

## 六、项目结构

```
pipeline-agent/
├── .env                              # 环境变量
├── .env.example                      # 环境变量模板
├── requirements.txt                  # Python依赖
├── docker-compose.yml               # 开发环境容器编排
│
├── knowledge_base/                   # 知识库原始文档
│   ├── standards/                    # 规范标准
│   │   ├── GB50251-管道设计规范.md
│   │   └── ...
│   ├── formulas/                     # 计算原理
│   │   ├── 水力学基础.md
│   │   └── ...
│   ├── operations/                   # 操作指南
│   └── cases/                        # 案例分析
│
├── src/
│   ├── __init__.py
│   ├── config.py                     # 配置管理
│   │
│   ├── models/                       # 数据模型
│   │   ├── __init__.py
│   │   ├── state.py                  # AgentState定义
│   │   ├── schemas.py                # Pydantic模型
│   │   └── enums.py                  # 枚举定义
│   │
│   ├── tools/                        # LangChain工具
│   │   ├── __init__.py
│   │   ├── database_tools.py         # 数据库查询工具
│   │   ├── calculation_tools.py      # 计算工具
│   │   ├── java_service_tools.py     # Java服务调用
│   │   └── knowledge_tools.py        # 知识检索工具
│   │
│   ├── rag/                          # Contextual RAG模块
│   │   ├── __init__.py
│   │   ├── document_processor.py     # 文档处理
│   │   ├── contextual_chunker.py     # 上下文分块(核心)
│   │   ├── embeddings.py             # 向量化
│   │   ├── vector_store.py           # Milvus存储
│   │   ├── hybrid_retriever.py       # 混合检索
│   │   ├── reranker.py               # 重排序
│   │   ├── self_rag.py               # 自适应检索
│   │   └── pipeline.py               # RAG Pipeline
│   │
│   ├── agents/                       # Agent定义
│   │   ├── __init__.py
│   │   ├── prompts.py                # Prompt模板
│   │   ├── supervisor.py             # Supervisor Agent
│   │   ├── data_agent.py             # Data Agent
│   │   ├── calc_agent.py             # Calc Agent
│   │   └── knowledge_agent.py        # Knowledge Agent
│   │
│   ├── workflows/                    # LangGraph工作流
│   │   ├── __init__.py
│   │   ├── nodes.py                  # 节点函数
│   │   ├── edges.py                  # 边条件函数
│   │   └── graph.py                  # 工作流定义
│   │
│   ├── memory/                       # Memory模块
│   │   ├── __init__.py
│   │   ├── conversation.py           # 对话历史
│   │   └── summary.py                # 历史摘要
│   │
│   ├── api/                          # FastAPI服务
│   │   ├── __init__.py
│   │   ├── main.py                   # 应用入口
│   │   ├── routes/
│   │   │   ├── chat.py               # 对话接口
│   │   │   ├── knowledge.py          # 知识库管理
│   │   │   └── health.py             # 健康检查
│   │   └── middleware/
│   │       ├── auth.py               # 认证中间件
│   │       └── logging.py            # 日志中间件
│   │
│   └── utils/                        # 工具函数
│       ├── __init__.py
│       ├── logger.py                 # 日志配置
│       └── helpers.py                # 辅助函数
│
├── scripts/                          # 脚本
│   ├── init_knowledge_base.py        # 初始化知识库
│   ├── test_rag.py                   # 测试RAG
│   └── test_agents.py                # 测试Agent
│
├── tests/                            # 测试
│   ├── test_env.py                   # 环境测试
│   ├── test_tools.py                 # 工具测试
│   ├── test_rag.py                   # RAG测试
│   └── test_workflow.py              # 工作流测试
│
└── docs/                             # 文档
    ├── api.md                        # API文档
    └── deployment.md                 # 部署文档
```

---

## 七、实施计划

### Phase 1: 基础环境与项目骨架 (Day 1)

```
任务清单:
□ 1.1 创建项目目录结构
□ 1.2 编写requirements.txt
□ 1.3 配置.env环境变量
□ 1.4 编写config.py配置管理
□ 1.5 定义AgentState数据模型
□ 1.6 验证Python环境和依赖

产出: 可运行的项目骨架
验收: python -c "from src.config import settings; print(settings)"
```

### Phase 2: 工具层实现 (Day 2)

```
任务清单:
□ 2.1 实现database_tools.py (MySQL查询)
□ 2.2 实现java_service_tools.py (调用Java计算服务)
□ 2.3 实现calculation_tools.py (本地计算)
□ 2.4 编写工具测试用例
□ 2.5 验证工具可用性

产出: 完整的工具集
验收: python scripts/test_tools.py 全部通过
```

### Phase 3: Contextual RAG 实现 (Day 3-4)

```
任务清单:
□ 3.1 实现document_processor.py (文档加载)
□ 3.2 实现contextual_chunker.py (上下文分块 - 核心)
□ 3.3 实现embeddings.py (向量化)
□ 3.4 实现vector_store.py (Milvus存储)
□ 3.5 实现hybrid_retriever.py (混合检索)
□ 3.6 实现reranker.py (重排序)
□ 3.7 实现self_rag.py (自适应检索)
□ 3.8 实现pipeline.py (完整RAG Pipeline)
□ 3.9 准备知识库文档
□ 3.10 初始化知识库并测试

产出: 生产级RAG系统
验收: 知识问答准确率 > 80%
```

### Phase 4: Agent 实现 (Day 5)

```
任务清单:
□ 4.1 编写prompts.py (Prompt模板)
□ 4.2 实现supervisor.py
□ 4.3 实现data_agent.py
□ 4.4 实现calc_agent.py
□ 4.5 实现knowledge_agent.py
□ 4.6 单Agent测试

产出: 4个可独立运行的Agent
验收: 各Agent单独测试通过
```

### Phase 5: LangGraph 工作流 (Day 6)

```
任务清单:
□ 5.1 实现nodes.py (节点函数)
□ 5.2 实现edges.py (路由条件)
□ 5.3 实现graph.py (工作流图)
□ 5.4 实现Memory机制
□ 5.5 端到端测试

产出: 完整的多Agent工作流
验收: 复合任务测试通过
```

### Phase 6: API服务与集成 (Day 7)

```
任务清单:
□ 6.1 实现FastAPI主应用
□ 6.2 实现对话接口 /api/v1/chat
□ 6.3 实现知识库管理接口
□ 6.4 添加认证中间件
□ 6.5 与Java Gateway对接测试
□ 6.6 编写API文档

产出: 可部署的API服务
验收: 通过Gateway调用Agent成功
```

---

## 八、验收标准

### 8.1 功能验收

| 测试场景 | 输入 | 预期输出 |
|----------|------|----------|
| 知识问答 | "什么是雷诺数" | 正确解释+引用来源 |
| 数据查询 | "查询项目P001的管道" | 返回管道参数 |
| 简单计算 | "计算雷诺数，流量100，管径400，粘度0.00005" | 返回Re值和流态 |
| Java调用 | "分析流量100时的水力特性" | 返回完整水力分析结果 |
| 复合任务 | "分析P001管道并给出优化建议" | 多Agent协作完成 |

### 8.2 性能指标

| 指标 | 目标值 |
|------|--------|
| 简单问答响应时间 | < 3秒 |
| 复合任务响应时间 | < 10秒 |
| RAG检索准确率 | > 85% |
| API并发支持 | > 10 QPS |

---

## 九、风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| LLM API不稳定 | 服务中断 | 多模型Fallback |
| 向量检索不准 | 回答质量差 | Contextual + Hybrid + Rerank |
| 多Agent死循环 | 系统卡死 | max_iterations限制 |
| Java服务超时 | 计算失败 | 超时重试 + 降级响应 |

---

## 十、下一步行动

1. **立即开始**: 按Phase 1创建项目结构
2. **并行准备**: 整理知识库文档
3. **验证环境**: 确保Milvus、MySQL、Java服务可用

> 开始执行: `python scripts/init_project.py`
