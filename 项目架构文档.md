# 管线能耗分析系统 - 技术架构文档

## 1. 系统概览

本系统采用前后端分离的微服务架构设计。后端基于 **Spring Cloud Alibaba** 生态构建，负责核心业务逻辑、数据处理与能耗计算；AI 智能分析模块基于 **Python (LangChain + LangGraph)** 构建，提供 RAG 知识库问答与智能体辅助功能。

## 2. 系统架构图

```mermaid
graph TD
    %% 客户端层
    Client([Web 前端 / 移动端])

    %% 网关层
    subgraph Gateway_Layer [网关层]
        Gateway[pipeline-gateway<br/>(Spring Cloud Gateway)]
        AuthFilter[Sa-Token 全局鉴权过滤器]
    end

    %% 认证与系统服务
    subgraph Auth_System [认证与基础服务]
        Auth[pipeline-auth<br/>(认证中心)]
        System[pipeline-system<br/>(用户/角色管理)]
    end

    %% 业务服务
    subgraph Business_Services [核心业务服务]
        Data[pipeline-data<br/>(基础数据管理)]
        Calc[pipeline-calculation<br/>(能耗计算引擎)]
    end

    %% AI 服务
    subgraph AI_Services [AI 智能服务]
        Agent[pipeline-ai<br/>(Python AI Agent)]
        RAG[RAG 知识库引擎]
    end

    %% 基础设施
    subgraph Infrastructure [基础设施 & 中间件]
        Nacos[(Nacos<br/>注册/配置中心)]
        Redis[(Redis<br/>缓存/会话共享)]
        MySQL[(MySQL 8.0<br/>业务数据库)]
        Milvus[(Milvus<br/>向量数据库)]
    end

    %% 链路关系
    Client --> Gateway
    Gateway --> AuthFilter
    AuthFilter -.->|校验 Token| Redis
    
    Gateway -->|/auth| Auth
    Gateway -->|/system| System
    Gateway -->|/data| Data
    Gateway -->|/calculation| Calc
    
    %% 服务间调用
    Calc -.->|Feign/Http| Data
    Calc -.->|Http| Agent
    Agent --> RAG
    
    %% 数据存储
    Auth --> MySQL
    System --> MySQL
    Data --> MySQL
    Agent --> Milvus
    
    %% 注册发现
    Gateway -.-> Nacos
    Auth -.-> Nacos
    System -.-> Nacos
    Data -.-> Nacos
    Calc -.-> Nacos
```

## 3. 核心模块说明

### 3.1 网关服务 (`pipeline-gateway`)
*   **技术栈**: Spring Cloud Gateway, Spring Cloud LoadBalancer, Sa-Token Reactor.
*   **职责**:
    *   统一入口：所有外部请求经过网关转发。
    *   **全局鉴权**：集成 Sa-Token 全局过滤器，拦截非 `/auth` 请求，校验 Redis 中的 Token 有效性。
    *   负载均衡：基于 Nacos 的服务发现与负载均衡。

### 3.2 认证中心 (`pipeline-auth`)
*   **技术栈**: Sa-Token, BCrypt, MySQL.
*   **职责**:
    *   用户登录：校验用户名/密码（BCrypt 加密）。
    *   Token 颁发：生成分布式 Token 并存入 Redis。
    *   会话管理：处理用户注销、Token 续期。

### 3.3 基础数据服务 (`pipeline-data`)
*   **技术栈**: MyBatis Plus, MySQL.
*   **职责**:
    *   管理项目基础信息（Project）。
    *   管理管线物理参数（Pipeline：长度、管径、壁厚等）。
    *   管理泵站设备参数（PumpStation：泵特性、电机效率等）。
    *   管理油品物性数据（OilProperty：密度、粘度）。

### 3.4 能耗计算服务 (`pipeline-calculation`)
*   **技术栈**: Java BigDecimal (高精度计算).
*   **核心算法**:
    *   **水力分析 (`HydraulicAnalysisStrategy`)**：复刻原 C# `AlgorithmLib` 逻辑，计算雷诺数、摩阻、水力坡降、首末站压力。
    *   **开泵优化 (`OptimizationStrategy`)**：遍历 8 种开泵组合，基于“末站压力最小化”原则推荐最优节能方案。

### 3.5 AI 智能体 (`pipeline-ai`)
*   **技术栈**: Python 3.11, FastAPI, LangChain, LangGraph, Milvus.
*   **职责**:
    *   **RAG 问答**：基于 Milvus 向量库检索技术文档，回答用户关于规范、操作手册的提问。
    *   **智能体编排**：通过 LangGraph 编排多 Agent 协作，可调用 Java 计算服务 API 进行自然语言驱动的能耗分析。

## 4. 关键技术栈

| 类别 | 技术选型 | 说明 |
| :--- | :--- | :--- |
| **开发语言** | Java 21, Python 3.11 | 后端主力与 AI 扩展 |
| **微服务框架** | Spring Cloud Alibaba | 2023.0.1.0 (Spring Boot 3.2.4) |
| **注册/配置** | Nacos | 2.3.2 |
| **权限认证** | **Sa-Token** + Redis | 轻量级分布式权限认证 |
| **持久层** | MyBatis Plus | 3.5.5 |
| **数据库** | MySQL 8.0 | 业务数据存储 |
| **缓存/会话** | Redis 7 | 分布式 Session 与 缓存 |
| **向量数据库** | Milvus | AI 知识库向量存储 |
| **AI 框架** | LangChain, LangGraph | LLM 应用开发与 Agent 编排 |

## 5. 核心业务流程

### 5.1 登录鉴权流程
1.  用户请求 `/auth/login`。
2.  `pipeline-auth` 校验账号密码。
3.  校验通过，调用 `StpUtil.login(userId)`，生成 Token 并存入 Redis。
4.  返回 Token 给客户端。
5.  客户端后续请求携带 Token。
6.  `pipeline-gateway` 全局过滤器拦截请求，调用 `StpUtil.checkLogin()` 检查 Redis 中 Token 是否有效。
7.  有效则放行至后端服务，无效则返回 401。

### 5.2 能耗计算流程
1.  用户发起计算请求（包含流量、温度、管线 ID 等参数）。
2.  `pipeline-calculation` 接收请求。
3.  调用 `HydraulicAnalysisStrategy` 进行水力特性计算（流态判断、摩阻计算）。
4.  调用 `OptimizationStrategy` 遍历开泵方案。
5.  筛选出满足 `末站压力 > 0` 且 `末站压力最小` 的方案作为推荐结果。
6.  返回计算结果与推荐方案。
